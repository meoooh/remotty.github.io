
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>active_model_serializers - Remotty Tech Blog</title>
	<meta name="author" content="Remotty Group">

	
	<meta name="description" content="active_model_serializers젬은 레일스 API 를 작성할 때 JSON 데이터를 만들기 위해 추천되는 젬입니다. 설치 Gemfile 에 추가하고 bundle install 합니다. 1
gem 'active_model_serializers' &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Remotty Tech Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Remotty Tech Blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:remotty.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/remotty" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:remotty.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Active_model_serializers</h2>
	<div class="entry-content"><p><code>active_model_serializers</code>젬은 레일스 API 를 작성할 때 JSON 데이터를 만들기 위해 추천되는 젬입니다.</p>

<h2>설치</h2>

<p>Gemfile 에 추가하고 bundle install 합니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem 'active_model_serializers'</span></code></pre></td></tr></table></div></figure>


<!--more-->


<h2>Serializer 생성하기</h2>

<p>이후부터 <code>scaffolding</code>이나 <code>model generator</code>를 사용하여 특정 모델을 생성하면 자동으로 <code>serializer</code>가 만들어 집니다.</p>

<p>이미 만들어진 모델에 대해서는 아래와 같이 직접 <code>serializer</code>를 생성할 수 있습니다. 여기서는 <code>Post</code> 모델에 대한 <code>serializer</code>를 생성하는 예를 들었습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rails g serializer post</span></code></pre></td></tr></table></div></figure>


<p>이제 <code>app/serializers/post_serializer.rb</code>에서 <code>Post</code> 모델에 대한 <code>serializer</code>를 볼 수 있게 됩니다.</p>

<h2>render :json</h2>

<p>컨트롤러에서 <code>render :json</code>을 사용하면, 우선적으로 해당 객체에 대한 <code>serializer</code>를 찾아보고 있으면 해당 <code>serializer</code>를 사용하게 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostsController &lt; ApplicationController
</span><span class='line'>  def show
</span><span class='line'>    @post = Post.find(params[:id])
</span><span class='line'>    render json: @post
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>배열</h2>

<p>배열에 대해서도 <code>render :json</code>을 사용할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :title, :body
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>class PostsController &lt; ApplicationController
</span><span class='line'>  def index
</span><span class='line'>    @posts = Post.all
</span><span class='line'>    render json: @posts
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>렌더링되는 결과는 아래와 같습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "posts":
</span><span class='line'>    [
</span><span class='line'>      { "title": "Post 1", "body": "Hello!" },
</span><span class='line'>      { "title": "Post 2", "body": "Goodbye!" }
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>디폴트로 컨트롤러의 이름이 루트 엘리먼트의 이름이 됩니다. 즉, <code>PostsController</code>는 <code>posts</code>라는 루트노드명을 만들어 줍니다. 또한 아래와 같이 루트노드명을 변경할 수도 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>render json: @posts, root: "some_posts"</span></code></pre></td></tr></table></div></figure>


<h2>루트 엘리먼트를 없애는 방법 4가지</h2>

<ul>
<li>모든 클래스에 대해서 루트 엘리먼트를 사용하지 않는 방법</li>
</ul>


<p>initializer 파일을 새로 만들어 아래와 같이 추가해 줍니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Disable for all serializers (except ArraySerializer)
</span><span class='line'>ActiveModel::Serializer.root = false
</span><span class='line'>
</span><span class='line'># Disable for ArraySerializer
</span><span class='line'>ActiveModel::ArraySerializer.root = false</span></code></pre></td></tr></table></div></figure>


<ul>
<li>컨트롤러에서 render 옵션으로 지정하는 방법</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>render json: @posts, root: false</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Serializer를 상속받는 방법</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CustomArraySerializer &lt; ActiveModel::ArraySerializer
</span><span class='line'>  self.root = false
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'># controller:
</span><span class='line'>render json: @posts, serializer: CustomArraySerializer</span></code></pre></td></tr></table></div></figure>


<ul>
<li>컨트로러에 <code>default_serializer_options</code> 메소드를 정의하는 방법</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def default_serializer_options
</span><span class='line'>  {
</span><span class='line'>    root: false
</span><span class='line'>  }
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>Attributes와 Associations</h2>

<p>serializer 클래스에서는 속성과 관계를 지정할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>Attributes</h2>

<p>attributes로 명시한 속성들에 대해서 serializer는 <code>render :json</code> 호출시에 넘겨준 액티브레코드 객체에 대해서 해당 속성들을 찾아보게 됩니다. 이 때 serializer는, <code>ActiveRecord</code> 객체가 속성을 조회하기 위해서는 사용하는 <code>read_attribute_for_serialization</code> 메소드를 이용하게 됩니다.</p>

<p>특정 객체에 대한 속성을 조회해 보기 전에, serializer는 해당 속성과 같은 이름의 메소드가 정의되어 있는지를 알아 보고 있다면 모델 속성을 포함하기 전에 해당 메소드의 결과를 속성으로 포함하게 됩니다.</p>

<p>예를 들면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PersonSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :first_name, :last_name, :full_name
</span><span class='line'>
</span><span class='line'>  def full_name
</span><span class='line'>    "#{object.first_name} #{object.last_name}"
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>serializer 메소드 내에서 객체는 <code>object</code>로써 접근하게 됩니다.
따라서 속성명이 <code>object</code> 라는 이름을 가질 경우 그 이름이 감춰지게 되므로 이 때는 <code>object.object</code>로써 접근할 수 있습니다. 예를 들면,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class VersionSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attribute :version_object, key: :object
</span><span class='line'>
</span><span class='line'>  def version_object
</span><span class='line'>    object.object
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>또한 <code>scope</code> 메소드를 사용할 수 있는데, 이것은 serializer에서 인증상태를 이용할 수 있게 해 줍니다. 디폴트로는 어플리케이션의 current user가 바로 이러한 인증상태에 해당하는 것이지만 다른 것으로 변경할 수도 있습니다.</p>

<p>serializer는 <code>filter</code>라는 메소드를 제공해 줍니다. 이것은 결과에 보여줄 attributes와 associations을 포함하는 배열을 반환해 줍니다. 일반적으로 이것은 <code>current_user</code>에 근거해서 결과를 다양하게 보여주기 위해서 사용합니다. 예를 들면 다음과 같습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body, :author
</span><span class='line'>
</span><span class='line'>  def filter(keys)
</span><span class='line'>    if scope.admin?
</span><span class='line'>      keys
</span><span class='line'>    else
</span><span class='line'>      keys - [:author]
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>별도의 keys 배열을 추가로 만들 필요없이, <code>keys.delete(:author)</code>를 이용하여 keys 인수를 변경하는 것이 안전할 것입니다. 주의할 것은 in-place 변경을 시도하더라도 변경된 배열을 여전히 반환할 필요가 있다는 것입니다.</p>

<p>액티브레코드 상의 이름과 다른 키를 사용하고 싶을 때는, 다른 이름의 키를 선언하고 메소드를 재정의하면 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  # look up subject on the model, but use title in the JSON
</span><span class='line'>  def title
</span><span class='line'>    object.subject
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  attributes :id, :body, :title
</span><span class='line'>  has_many :comments
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>JSON 결과물에 메타 정보를 포함하고잘 할 경우에는, <code>:meta</code> 옵션을 사용하면 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>render json: @posts, serializer: CustomArraySerializer, meta: {total: 10}</span></code></pre></td></tr></table></div></figure>


<p>그러면 아래와 같은 결과를 보여 줄 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "meta": { "total": 10 },
</span><span class='line'>  "posts": [
</span><span class='line'>    { "title": "Post 1", "body": "Hello!" },
</span><span class='line'>    { "title": "Post 2", "body": "Goodbye!" }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>또한 <code>:meta_key</code> 옵션을 사용하면 메타 키 이름을 변경할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>render json: @posts, serializer: CustomArraySerializer, meta: {total: 10}, meta_key: 'meta_object'</span></code></pre></td></tr></table></div></figure>


<p><code>:meta_key</code> 옵션을 사용하면 아래와 같은 결과를 보여 줄 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "meta_object": { "total": 10 },
</span><span class='line'>  "posts": [
</span><span class='line'>    { "title": "Post 1", "body": "Hello!" },
</span><span class='line'>    { "title": "Post 2", "body": "Goodbye!" }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>이와 같이 메타 정보를 이용할 경우에는, serializer는 <code>{ root: false }</code> 옵션을 가질 수 없습니다. 결국 유효하지 않는 JSON 데이터를 반화하기 때문에 루트 키가 없는 경우에는 메타 정보가 무시될 것입니다.</p>

<p>attribute 직렬화 과정을 직접 로우레벌에서 조작하고자 할 경우에는, <code>attributes</code> 메소드를 덮어쓰기해서 해시를 반환해 주면 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PersonSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :first_name, :last_name
</span><span class='line'>
</span><span class='line'>  def attributes
</span><span class='line'>    hash = super
</span><span class='line'>    if scope.admin?
</span><span class='line'>      hash["ssn"] = object.ssn
</span><span class='line'>      hash["secret"] = object.mothers_maiden_name
</span><span class='line'>    end
</span><span class='line'>    hash
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h2>Associations</h2>

<p>association을 사용할 경우, serializer가 해당 association을 찾아보고 연관객체의 각 엘리먼트를 직렬화하게 됩니다. 예를 들어, <code>has_many :comments</code> 라고 지정하면 각 comment 객체에 대해서 CommentSerializer 객체를 만들어서 직렬화하게 되는 것입니다.</p>

<p>디폴트 상태에서는 오리지날 객체에 대해서 선언되어 있는 association을 찾게 됩니다. 그러나 해당 association 이름과 동일한 메소드를 정의하여 반환되는 객체들을 변경할 수 있습니다. 이것은 특정 scope(current_user와 같은)에 국한된 객체들을 반환할 때 사용하면 도움이 될 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments
</span><span class='line'>
</span><span class='line'>  # only let the user see comments he created.
</span><span class='line'>  def comments
</span><span class='line'>    object.comments.where(created_by: scope)
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>이 경우에도 attributes와 같이 JSON 키를 변경할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>
</span><span class='line'>  # look up comments, but use +my_comments+ as the key in JSON
</span><span class='line'>  has_many :comments, root: :my_comments
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>또한 attributes와 같이, <code>filter</code> 메소드를 정의하면, 결과로써 포함할 associations을 지정할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments
</span><span class='line'>
</span><span class='line'>  def filter(keys)
</span><span class='line'>    keys.delete :comments if object.comments_disabled?
</span><span class='line'>    keys
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>또는</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_one :author
</span><span class='line'>  has_many :comments
</span><span class='line'>
</span><span class='line'>  def filter(keys)
</span><span class='line'>    keys.delete :author unless scope.admin?
</span><span class='line'>    keys.delete :comments if object.comments_disabled?
</span><span class='line'>    keys
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p><code>:serializer</code> 옵션을 이용하여 커스텀 serializer 클래스를 지정할 수 있고 <code>:polymorphic</code> 옵션을 지정하여 해당 association이 polymorphic 이라는 것을 알려줄 수 있습니다.</p>

<p>serializer에서는 <code>belongs_to</code> association을 <code>has_one</code>을 이용하여 포함하게 된다는 것을 주의해야 합니다.</p>

<h2>Embedding Associations</h2>

<p>디폴트 상태에서는 associations가 serializer 객체에 포함(embeded)됩니다. 그래서 하나의 post 가 있다고 가정할 때 다음과 같은 결과를 볼 수 있게 될 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comments": [
</span><span class='line'>      { "id": 1, "body": "what a dumb post" }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>이러한 결과물은 간단한 경우에는 편리하지만, 복잡한 association이 존재할 경우에는 해당 association 에 대해서 ID이 구성된 배열을 포함하는 것이 더 좋을 것입니다. 이것은 전체적인 퍼포먼스 측면에서도 그렇고 불필요한 중복을 피할 수 있어서 좋습니다.</p>

<p>이를 위해서 <code>embed</code>라는 클래스 메소드를 사용하면 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  embed :ids
</span><span class='line'>
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>이제 association들이 ID들로 구성된 배열을 포함하게 될 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comment_ids": [ 1, 2, 3 ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>다른 방법으로는 클래스내의 측정 association에 대해서만 ID 또는 객체 배열만을 포함할 수 있게 할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>
</span><span class='line'>  has_many :comments, embed: :objects
</span><span class='line'>  has_many :tags, embed: :ids
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>따라서 JSON 데이터는 다음과 같이 보일 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comments": [
</span><span class='line'>      { "id": 1, "body": "what a dumb post" }
</span><span class='line'>    ],
</span><span class='line'>    "tag_ids": [ 1, 2, 3 ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>게다가, ID 만을 포함하는 것 외에도 메인 객체에 데이터를 추가로 포함할 수도 있습니다. 이렇게 하므로써 포함된 정보를 검색하기 위해서 트리구조를 스캔할 필요없이 전체 데이터 패키지를 보다 쉽게 처리할 수 있게 될 것입니다. 또한 객체사이에 (tags와 같이) 공유되는 associations들은 전체 로드시에 단 한번만 전달된다는 것입니다.</p>

<p>아래와 같이 데이터가 포함되도록 명시할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  embed :ids, include: true
</span><span class='line'>
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>이 때 comments 객체가 <code>has_many :tags</code> association이 선언되어 있다고 가정하면, 다음과 같은 JSON 데이터를 얻게 될 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comment_ids": [ 1, 2 ]
</span><span class='line'>  },
</span><span class='line'>  "comments": [
</span><span class='line'>    { "id": 1, "body": "what a dumb post", "tag_ids": [ 1, 2 ] },
</span><span class='line'>    { "id": 2, "body": "i liked it", "tag_ids": [ 1, 3 ] },
</span><span class='line'>  ],
</span><span class='line'>  "tags": [
</span><span class='line'>    { "id": 1, "name": "short" },
</span><span class='line'>    { "id": 2, "name": "whiny" },
</span><span class='line'>    { "id": 3, "name": "happy" }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>위에서와 같이 데이터를 추가로 로드할 경우에는 <code>{ root: false }</code> 옵션을 사용할 수 없습니다. 이 옵션을 지정할 경우에는 유효하지 않은 JSON 데이터를 만들게 되기 때문입니다. 따라서 이 옵션을 지정하게 되면 <code>include</code> 옵션이 작동하지 않게 됩니다.</p>

<p>또한 포함된 객체에 대해서는 참조하는 키외의 다른 루트를 지정할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  embed :ids, include: true
</span><span class='line'>
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments, key: :comment_ids, root: :comment_objects
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>이것은 다음과 같은 JSON 데이터를 민들게 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comment_ids": [ 1 ]
</span><span class='line'>  },
</span><span class='line'>  "comment_objects": [
</span><span class='line'>    { "id": 1, "body": "what a dumb post" }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>또한 포함된 객체의 ID외의 다른 속성을 지정할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class PostSerializer &lt; ActiveModel::Serializer
</span><span class='line'>  embed :ids, include: true
</span><span class='line'>
</span><span class='line'>  attributes :id, :title, :body
</span><span class='line'>  has_many :comments, embed_key: :external_id
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>이것은 다음과 같은 JSON 데이터를 만들게 됩니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "post": {
</span><span class='line'>    "id": 1,
</span><span class='line'>    "title": "New post",
</span><span class='line'>    "body": "A body!",
</span><span class='line'>    "comment_ids": [ "COMM001" ]
</span><span class='line'>  },
</span><span class='line'>  "comments": [
</span><span class='line'>    { "id": 1, "external_id": "COMM001", "body": "what a dumb post" }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Note: <code>embed :ids</code> 기전은 주로 데이터를 대량으로 처리해서 로컬 저장소에 로드할 경우에 유용합니다. 이와 같은 경우에, 정보검색을 위해서 데이터를 반복적으로 스캔할 필요없이 종류별로 모든 데이터를 쉽게 볼 수 있다는 것은 매우 유용한 기능입니다.</p>

<p>대부분의 경우 간단히 시나리오 하에 데이터 작업을 하고 직접 Ajax 요청을 할 경우에는 아마도 디폴트 상태의 embed 기능을만을 사용하면 될 것입니다.</p>

<h2>Scope 커스터마이징하기</h2>

<p>특정 serializer 클래스에서 대해서, <code>current_user</code> 는 <code>render :json</code> 을 호출할 때 컨트롤러가 해당 serializer에 제공하는 인증 scope에 해당합니다. 디폴트로, 이것은 <code>current_user</code>가 되지만, 컨트롤러에서 <code>serialization_scope</code>을 호출하여 이 scope을 변경할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ApplicationController &lt; ActionController::Base
</span><span class='line'>  serialization_scope :current_admin
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>위의 예는 scope을 <code>current_user</code>에서 <code>current_admin</code>으로 변경하게 될 것입니다.</p>

<p>주목할 것은, 지금까지 볼 때, <code>serialization_scope</code>은 두번째 인수를 지정하여, 해당 scope을 적용할 액션들을 지정할 수 없습니다.</p>

<p>즉, 아래와 같이 액션들을 지정할 수 없다는 것입니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class SomeController &lt; ApplicationController
</span><span class='line'>  serialization_scope :current_admin, except: [:index, :show]
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>따라서 대신에 아래와 같이 처리할 수 있습니다.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CitiesController &lt; ApplicationController
</span><span class='line'>  serialization_scope nil
</span><span class='line'>
</span><span class='line'>  def index
</span><span class='line'>    @cities = City.all
</span><span class='line'>
</span><span class='line'>    render json: @cities, each_serializer: CitySerializer
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def show
</span><span class='line'>    @city = City.find(params[:id])
</span><span class='line'>
</span><span class='line'>    render json: @city, scope: current_admin
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>위에 예에서, <code>current_admin</code> 메소드가 데이터베이스에서 현재 사용자를 조회할 필요가 있다고 가정한다면, 이러한 방식의 접근방식을 통해서, <code>serailization_scope</code>값은 <code>nil</code>로 지정하므로써, <code>index</code> 액션이 더 이상 데이터베이스를 조회하기 않고 단지, <code>show</code> 액션만이 해당 메소드를 실행하게 되는 것입니다.</p>

<h2>Testing</h2>

<p>임의의 serializer 클래스를 테스트하기 위해서는, 단지 해당 serializer 클래스에 대해서 <code>.new</code> 메소드를 호출하여 모델 클래스 객체를 넘겨 주면 됩니다.</p>

<h2>MiniTest</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class TestPostSerializer &lt; Minitest::Test
</span><span class='line'>  def setup
</span><span class='line'>    @serializer = PostSerializer.new Post.new(id: 123, title: 'some title', body: 'some text')
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  def test_special_json_for_api
</span><span class='line'>    assert_equal '{"post":{"id":123,"title":"some title","body":"some text"}}', @serializer.to_json
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<h2>RSpec</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>describe PostSerializer do
</span><span class='line'>  it "creates special JSON for the API" do
</span><span class='line'>    serializer = PostSerializer.new Post.new(id: 123, title: 'some title', body: 'some text')
</span><span class='line'>    expect(serializer.to_json).to eql('{"post":{"id":123,"title":"some title","body":"some text"}}')
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>수고하셨습니다.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-12-31T19:51:34+09:00" pubdate data-updated="true">Dec 31<span>st</span>, 2013</time></div>
	<div class='author'>
  


최효성

</div>
	<div class="tags">


	<a class='category' href='/blog/categories/gem/'>gem</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Remotty Group

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'remotty';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://remotty.github.io/blog/2013/12/31/active-model-serializers/';
        var disqus_url = 'http://remotty.github.io/blog/2013/12/31/active-model-serializers/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
  Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46197100-2', 'remotty.github.io');
  ga('send', 'pageview');
</script>


</body>
</html>